<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Meeting Room Display</title>
<style>
  body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    color: white;
    text-align: center;
    background-color: #2e7d32;
    transition: background-color 0.5s;
  }
  h1 { font-size: 100px; margin: 0; }
  h2 { font-size: 30px; margin-top: 20px; }
  .booking {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 40px;
    margin: 0 auto;
    text-align: center;
    font-style: italic;
    color: rgba(255,255,255,0.95);
    padding: 0 12px;
  }
</style>
</head>
<body id="body">
  <div>
    <h1 id="status">Loading...</h1>
    <h2 id="details"></h2>
  </div>
  <p class="booking">You can book this meeting room via Notion or Google Calendar.</p>

<script>
  const CALENDAR_ID = "c_188d7qdmm4t2mjjum1lqle5l6u8ke@resource.calendar.google.com";
  const API_KEY = "AIzaSyDYouq-OUTtfWKE4KPkZYk7n873GVFsrm4";

  let nextEventStart = null;
  let currentEventEnd = null;
  let nextEventName = null;
  let countdownInterval = null;

  function updateCountdown() {
    const now = new Date();
    const details = document.getElementById('details');

    if (currentEventEnd) {
      const minsLeft = Math.max(0, Math.ceil((currentEventEnd - now) / 60000));
      details.innerHTML = "<u>" + minsLeft + " minutes</u> left Â· <u>" + nextEventName + "</u>";
    } else if (nextEventStart) {
      const minsUntil = Math.max(0, Math.ceil((nextEventStart - now) / 60000));
      details.innerHTML = "Next Meeting in <u>" + minsUntil + "'</u> for <u>" + nextEventName + "</u>";
    }
  }

  async function loadStatus() {
    try {
      const now = new Date();
      const timeMin = now.toISOString();
      const timeMax = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59).toISOString();

      const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(CALENDAR_ID)}/events?key=${API_KEY}&timeMin=${timeMin}&timeMax=${timeMax}&singleEvents=true&orderBy=startTime&maxResults=10`;

      const res = await fetch(url);
      const data = await res.json();
      const events = data.items || [];

      const body = document.getElementById("body");
      const status = document.getElementById("status");
      const details = document.getElementById("details");

      if (countdownInterval) clearInterval(countdownInterval);
      nextEventStart = null;
      currentEventEnd = null;
      nextEventName = null;

      let currentEvent = null;
      let nextEvent = null;

      for (const event of events) {
        const start = new Date(event.start.dateTime || event.start.date);
        const end = new Date(event.end.dateTime || event.end.date);

        if (start <= now && end >= now) {
          currentEvent = event;
        }
        if (start > now && !nextEvent) {
          nextEvent = event;
        }
      }

      if (currentEvent) {
        // BUSY
        body.style.backgroundColor = "#d32f2f";
        status.innerText = "BUSY";
        currentEventEnd = new Date(currentEvent.end.dateTime || currentEvent.end.date);
        nextEventName = currentEvent.summary;
        updateCountdown();
        countdownInterval = setInterval(updateCountdown, 10000);

      } else if (nextEvent) {
        const nextStart = new Date(nextEvent.start.dateTime || nextEvent.start.date);
        const diffMinutes = (nextStart - now) / 60000;

        if (diffMinutes <= 15) {
          // SOON
          body.style.backgroundColor = "#f9a825";
          status.innerText = "SOON";
          nextEventStart = nextStart;
          nextEventName = nextEvent.summary;
          updateCountdown();
          countdownInterval = setInterval(updateCountdown, 10000);

        } else {
          // FREE with upcoming meeting
          body.style.backgroundColor = "#2e7d32";
          status.innerText = "AVAILABLE";
          nextEventStart = nextStart;
          nextEventName = nextEvent.summary;
          updateCountdown();
          countdownInterval = setInterval(updateCountdown, 10000);
        }

      } else {
        // FREE with no meetings
        body.style.backgroundColor = "#2e7d32";
        status.innerText = "AVAILABLE";
        details.innerText = "";
      }

    } catch (err) {
      console.error(err);
    }
  }

  loadStatus();
  setInterval(loadStatus, 120000);
</script>
</body>
</html>